name: Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          tools: composer:v2
          coverage: none

      - name: Install Composer deps (prod)
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Build Vite assets
        run: |
          npm ci
          npm run build
          test -f public/build/manifest.json

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Rsync to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          rsync -az --delete \
            --exclude=".env" \
            --exclude="storage/*.key" \
            --exclude="storage/logs" \
            --exclude="storage/framework/cache" \
            --exclude="storage/framework/sessions" \
            --exclude="storage/framework/views" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}

      - name: Run post-deploy commands
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'SSH'
            set -e
            cd /var/www/breadofgrace/ehc-app

            php artisan optimize:clear
            php artisan migrate --force

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            sudo systemctl reload php8.5-fpm || true
            sudo systemctl reload nginx || true
          SSH
