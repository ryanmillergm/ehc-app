name: Deploy

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          tools: composer:v2
          coverage: none

      - name: Install Composer deps (prod)
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Build Vite assets
        run: |
          npm ci
          npm run build
          test -f public/build/manifest.json

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Rsync to server (safe for Laravel runtime dirs)
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          rsync -rz \
            --delete-delay \
            --delay-updates \
            --no-times --omit-dir-times \
            --no-perms --no-owner --no-group \
            --exclude=".env" \
            --exclude=".git/**" \
            --exclude="node_modules/**" \
            --exclude="public/storage" \
            --exclude="storage/*.key" \
            --exclude="storage/logs/**" \
            --exclude="storage/framework/cache/**" \
            --exclude="storage/framework/sessions/**" \
            --exclude="storage/framework/views/**" \
            --exclude="storage/framework/testing/**" \
            --exclude="storage/app/public/**" \
            --exclude="storage/app/livewire-tmp/**" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}

      - name: Post-deploy (migrate, cache, restart)
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'SSH'
            set -euo pipefail
            cd "${DEPLOY_PATH}"

            # Ensure runtime dirs exist
            mkdir -p storage bootstrap/cache

            # Runtime perms: deploy owns, www-data group; setgid dirs so group sticks
            sudo chown -R deploy:www-data storage bootstrap/cache
            sudo find storage bootstrap/cache -type d -exec chmod 2775 {} \;
            sudo find storage bootstrap/cache -type f -exec chmod 664 {} \;

            php artisan optimize:clear
            php artisan migrate --force

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            sudo systemctl restart php8.5-fpm
            sudo systemctl reload nginx
          SSH
